#!/bin/bash

set -o nounset

NAME=cypress
IMAGE=cypress/included:$(jq -r .devDependencies.cypress package.json)

copy() {
    local untrusted=$1
    tmp1=$(mktemp --tmpdir)
    tmp2=$(mktemp --tmpdir)
    xauth -f "${tmp1}" generate "$DISPLAY" . "$untrusted" timeout 0
    xauth -f "${tmp1}" nlist "$DISPLAY" | sed -e 's/^..../ffff/' | xauth -f "${tmp2}" nmerge -

    chmod +r "${tmp2}"
    echo "${tmp2}"
}

declare -a wayland_args

if [ ! -z ${WAYLAND_DISPLAY:-} ]; then
    wayland_args=(
        --volume=${HOME}/.config/electron25-flags.conf:/home/node/.config/electron25-flags.conf
        --volume=${XDG_RUNTIME_DIR}/${WAYLAND_DISPLAY:-}:/tmp/${WAYLAND_DISPLAY:-}
        --env "WAYLAND_DISPLAY"
        --env "XDG_SESSION_TYPE=wayland"
        --env "GDK_BACKEND=wayland"
    )
fi

xcookie="$(copy untrusted)"
podman run --name=${NAME} \
            --rm \
            --cap-drop ALL \
            --cap-add SETUID \
            --cap-add SETGID \
            --cap-add AUDIT_WRITE \
            --cap-add DAC_OVERRIDE \
            --cap-add CHOWN \
            --security-opt no-new-privileges \
            --shm-size 2g \
            --tmpfs /run \
            --volume=/etc/localtime:/etc/localtime:ro \
            --volume=/etc/machine-id:/etc/machine-id:ro \
            --volume=/tmp/.X11-unix:/tmp/.X11-unix:ro \
            --volume="$xcookie":/tmp/.Xauthority \
            --volume="$(pwd)":/app \
            --volume=cypress-config:/home/node/.config/Cypress/cy/production \
            --volume=cypress-pki:/home/node/.pki/nssdb \
            -w /app \
            --network host \
            --user=$(id -u):$(id -g) \
            --userns=keep-id \
            --env "HOME=/home/node" \
            --env "DISPLAY=${DISPLAY}" \
            --env "XAUTHORITY=/tmp/.Xauthority" \
            --env "LANG=en_US.UTF-8" \
            --env "CYPRESS_TARGET_ENV" \
            --env "XDG_RUNTIME_DIR=/tmp" \
            --env "TZ" \
            "${wayland_args[@]}" \
            --init \
            --entrypoint cypress \
            "${IMAGE}" "${@}"
